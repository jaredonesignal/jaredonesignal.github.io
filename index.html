<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneSignal Push Receiver â€” JTestWeb</title>

  <!-- OneSignal Web SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
           background:#0b1020; color:#e5e7eb; margin:0; min-height:100vh;
           display:grid; place-items:center; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:16px; padding:24px; max-width:560px; width:92%; }
    button { background:#3b82f6; border:none; color:white; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    code { background:#0f172a; padding:8px 12px; border-radius:8px; color:#93c5fd; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; background:#0f172a; border:1px solid #1f2937; border-radius:8px; padding:10px; margin-top:12px; }
    .muted { color:#9ca3af; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ðŸ”” OneSignal Web Push Receiver (JTestWeb)</h2>
    <p class="muted">Click the button to enable notifications and get your Player ID.</p>
    <button id="enable">Enable Notifications</button>

    <p style="margin-top:16px;">Player ID:</p>
    <code id="playerId">â€”</code>

    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <script>
    const APP_ID = "4bd637c1-11d5-46bf-b1c3-c203b648b25e";
    const REPO = "JTestWeb";

    const $ = (id) => document.getElementById(id);
    const log = (m) => { $("log").textContent += `${new Date().toLocaleTimeString()} â€” ${m}\n`; };

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      try {
        log("Initializing OneSignalâ€¦");

        // Force worker under /JTestWeb/ (project-site scope)
        await OneSignal.init({
          appId: APP_ID,
          allowLocalhostAsSecureOrigin: true,

          // v15-style keys (still honored)
          serviceWorkerPath: `/${REPO}/OneSignalSDKWorker.js`,
          serviceWorkerParam: { scope: `/${REPO}/` },

          // v16-style object (extra safety)
          serviceWorker: {
            path: `/${REPO}/OneSignalSDKWorker.js`,
            params: { scope: `/${REPO}/` },
          },
        });

        log("SDK initialized.");
        await refreshStatus(OneSignal);

        // Keep UI in sync
        OneSignal.User.PushSubscription.addEventListener("change", (event) => {
          const id = event?.current?.id || "";
          $("playerId").textContent = id || "â€”";
          log("PushSubscription change:\n" + JSON.stringify(event, null, 2));
        });

        $("enable").addEventListener("click", async () => {
          try {
            const canReq = await OneSignal.Notifications.canRequestPermission();
            log(`canRequestPermission: ${canReq}`);
            if (!canReq) {
              log("Permission blocked. In address bar â†’ Site settings â†’ Notifications â†’ Allow.");
              return;
            }
            log("Requesting permissionâ€¦");
            const granted = await OneSignal.Notifications.requestPermission();
            log(`Permission result: ${granted}`);
            if (!granted) return;

            log("Opting inâ€¦");
            await OneSignal.User.PushSubscription.optIn();
            await refreshStatus(OneSignal);
          } catch (e) {
            log("Enable error: " + (e.message || e));
          }
        });
      } catch (e) {
        log("Init error: " + (e.message || e));
      }
    });

    async function refreshStatus(OneSignal) {
      const permission = OneSignal.Notifications.permission;   // boolean (v16)
      const optedIn = OneSignal.User.PushSubscription.optedIn; // boolean
      let id = "";
      try { id = OneSignal.User.PushSubscription.id || ""; } catch (_) {}
      $("playerId").textContent = id || "â€”";
      log(JSON.stringify({ permission, optedIn, id }, null, 2));
    }
  </script>
</body>
</html>
